<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulacro UNT - √Årea C | PrepIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .option-btn { transition: all 0.2s ease; }
        .option-btn:hover:not(.selected):not(.disabled) { background-color: #f3f4f6; transform: translateX(5px); }
        .option-btn.selected { background-color: #e0e7ff; border-color: #6366f1; font-weight: bold; }
        .nav-grid-btn { width: 35px; height: 35px; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; border-radius: 0.375rem; transition: all 0.2s; }
        .nav-grid-btn.active { border: 2px solid #4f46e5; transform: scale(1.1); }
        .nav-grid-btn.answered { background-color: #e0e7ff; color: #4338ca; }
        .nav-grid-btn.current { background-color: #4f46e5; color: white; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg text-white"><span class="font-bold text-xl">UNT</span></div>
                <div>
                    <h1 class="text-lg font-bold text-gray-800 leading-tight">Simulacro de Admisi√≥n</h1>
                    <p class="text-xs text-gray-500">√Årea C - Ciencias de la Persona</p>
                </div>
            </div>
            <div class="hidden md:flex flex-col items-end">
                <span class="text-xs text-gray-500 uppercase font-semibold">Tiempo Restante</span>
                <span id="timeDisplay" class="text-2xl font-mono font-bold text-indigo-600">03:00:00</span>
            </div>
            <button id="finishBtnTop" onclick="finishExam()" class="hidden px-4 py-2 bg-red-50 text-red-600 font-bold rounded-lg hover:bg-red-100 transition text-sm">Finalizar</button>
        </div>
    </header>

    <div class="flex-1 max-w-7xl mx-auto w-full p-4 gap-6 flex flex-col md:flex-row">
        
        <div id="introScreen" class="flex-1 flex flex-col items-center justify-center bg-white rounded-2xl shadow-lg p-8 text-center">
            <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mb-6">
                <svg class="h-12 w-12 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
            </div>
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Examen Tipo Admisi√≥n UNT</h2>
            <p class="text-gray-600 mb-8 max-w-md">100 preguntas (IA o Simulaci√≥n). Tienes 3 horas.</p>
            <button onclick="startExam()" class="bg-indigo-600 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-indigo-700 transition transform hover:-translate-y-1">Comenzar Examen Ahora</button>
        </div>

        <div id="examContent" class="hidden flex-1 flex flex-col md:flex-row gap-6 w-full">
            <div class="flex-1 flex flex-col">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-4 flex-1">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span id="questionCategory" class="inline-block px-3 py-1 bg-purple-100 text-purple-700 text-xs font-bold rounded-full mb-2">Materia</span>
                            <h3 class="text-gray-500 text-sm font-medium">Pregunta <span id="currentQNum">1</span> de <span id="totalQNum">100</span></h3>
                        </div>
                    </div>
                    <div id="questionText" class="text-lg font-medium text-gray-900 mb-6 leading-relaxed">Cargando...</div>
                    <div id="optionsContainer" class="space-y-3"></div>
                </div>
                <div class="flex justify-between items-center bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                    <button id="prevBtn" onclick="prevQuestion()" class="px-6 py-2 bg-gray-100 text-gray-700 font-semibold rounded-lg transition">‚Üê Anterior</button>
                    <button id="nextBtn" onclick="nextQuestion()" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">Siguiente ‚Üí</button>
                </div>
            </div>

            <div class="w-full md:w-80 flex-shrink-0">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 sticky top-24">
                    <h4 class="font-bold text-gray-800 mb-4">Navegaci√≥n <span class="text-xs font-normal text-gray-500 ml-2"><span id="answeredCount">0</span>/100</span></h4>
                    <div id="questionGrid" class="grid grid-cols-5 gap-2 max-h-[400px] overflow-y-auto pr-2 mb-6"></div>
                    <button onclick="finishExam()" class="w-full bg-gradient-to-r from-red-500 to-pink-600 text-white font-bold py-3 rounded-xl shadow transition">Terminar Examen</button>
                </div>
            </div>
        </div>

        <div id="resultsScreen" class="hidden flex-1 bg-white rounded-2xl shadow-lg p-8 text-center max-w-3xl mx-auto mt-10">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">Resultados</h2>
            <div class="grid grid-cols-3 gap-6 mb-8">
                <div class="bg-blue-50 p-6 rounded-2xl"><p class="text-blue-600 font-medium">Puntaje</p><p id="totalScore" class="text-4xl font-bold text-blue-700">0</p></div>
                <div class="bg-green-50 p-6 rounded-2xl"><p class="text-green-600 font-medium">Aciertos</p><p id="totalCorrect" class="text-4xl font-bold text-green-700">0</p></div>
                <div class="bg-red-50 p-6 rounded-2xl"><p class="text-red-600 font-medium">Errores</p><p id="totalIncorrect" class="text-4xl font-bold text-red-700">0</p></div>
            </div>
            <button onclick="location.reload()" class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition">Volver a intentar</button>
        </div>
    </div>

    <script>
        // 1. Variables Globales
        let examQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let timerInterval;
        let timeLeft = 180 * 60;
        const API_EXAM_URL = 'https://mi-plataforma-ia-2.onrender.com/api/ai/generate-exam';

        // 2. Funciones
        async function startExam() {
            const btn = document.querySelector('#introScreen button');
            btn.disabled = true;
            btn.innerHTML = 'ü§ñ Generando examen... (espera)';
            
            try {
                // Intentamos conectar con la IA
                const response = await fetch(API_EXAM_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ area: "C", topics: ["Psicolog√≠a", "Filosof√≠a", "Lenguaje", "Historia", "C√≠vica", "Matem√°tica", "Biolog√≠a"] })
                });

                if (!response.ok) throw new Error('Error de red');
                const data = await response.json();
                
                if (data.success && data.questions.length > 0) {
                    examQuestions = data.questions;
                } else {
                    throw new Error('Datos inv√°lidos');
                }
            } catch (e) {
                console.warn("Usando modo offline por error:", e);
                generateLocalQuestions(); // <-- AQU√ç EST√Å LA CLAVE: Si falla la IA, generamos las 100 locales
            }

            setupExam();
        }

        function generateLocalQuestions() {
            examQuestions = [];
            const categories = ["Psicolog√≠a", "Historia", "Lenguaje", "Matem√°tica", "Biolog√≠a"];
            
            // 5 Preguntas Reales de Ejemplo (Extra√≠das del PDF)
            const realQs = [
                {c: "Psicolog√≠a", q: "Seg√∫n James Marcia, el proceso de examinar roles se llama:", o: ["Difusi√≥n", "Hipoteca", "Moratoria", "Logro", "Regresi√≥n"], a: 2},
                {c: "C√≠vica", q: "Organismo para conflictos territoriales en Am√©rica:", o: ["ONU", "OEA", "CAN", "MERCOSUR", "OTAN"], a: 1},
                {c: "Historia", q: "Herramienta del Paleol√≠tico superior:", o: ["Lascas", "Hachas", "Microlitos", "Bifaces", "N√∫cleos"], a: 2},
                {c: "Matem√°tica", q: "N√∫mero de tri√°ngulos con 101 varillas:", o: ["50", "51", "52", "53", "54"], a: 0},
                {c: "Biolog√≠a", q: "Fecundaci√≥n en la mujer ocurre en:", o: ["Oviducto", "Corteza", "M√©dula", "Fol√≠culo", "Endometrio"], a: 0}
            ];
            
            // Bucle para crear las 100 preguntas
            for(let i=0; i<100; i++) {
                if(i < realQs.length) {
                    // Usar preguntas reales para las primeras 5
                    examQuestions.push({id: i+1, category: realQs[i].c, question: realQs[i].q, options: realQs[i].o, correct: realQs[i].a});
                } else {
                    // Generar preguntas de relleno para las otras 95
                    examQuestions.push({
                        id: i+1, 
                        category: categories[i % categories.length],
                        question: `Pregunta simulada N¬∞ ${i+1}. (Conecta el Backend para ver preguntas reales generadas por IA)`,
                        options: ["Alternativa A", "Alternativa B", "Alternativa C", "Alternativa D", "Alternativa E"],
                        correct: 0
                    });
                }
            }
        }

        function setupExam() {
            document.getElementById('introScreen').classList.add('hidden');
            document.getElementById('examContent').classList.remove('hidden');
            document.getElementById('finishBtnTop').classList.remove('hidden');
            document.getElementById('totalQNum').textContent = examQuestions.length;
            
            userAnswers = new Array(examQuestions.length).fill(null);
            renderGrid();
            loadQuestion(0);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                const h = Math.floor(timeLeft/3600).toString().padStart(2,'0');
                const m = Math.floor((timeLeft%3600)/60).toString().padStart(2,'0');
                const s = (timeLeft%60).toString().padStart(2,'0');
                document.getElementById('timeDisplay').textContent = `${h}:${m}:${s}`;
                if(timeLeft <= 0) finishExam();
            }, 1000);
        }

        function renderGrid() {
            const grid = document.getElementById('questionGrid');
            grid.innerHTML = '';
            examQuestions.forEach((_, i) => {
                const btn = document.createElement('button');
                btn.className = 'nav-grid-btn bg-gray-100 text-gray-600 hover:bg-gray-200';
                btn.textContent = i+1;
                btn.onclick = () => loadQuestion(i);
                btn.id = `grid-btn-${i}`;
                grid.appendChild(btn);
            });
        }

        function loadQuestion(index) {
            currentQuestionIndex = index;
            const q = examQuestions[index];
            document.getElementById('currentQNum').textContent = index+1;
            document.getElementById('questionCategory').textContent = q.category;
            document.getElementById('questionText').textContent = q.question;
            
            const cont = document.getElementById('optionsContainer');
            cont.innerHTML = '';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = `option-btn w-full text-left p-4 border border-gray-200 rounded-xl flex items-center ${userAnswers[index]===i ? 'selected' : ''}`;
                btn.innerHTML = `<span class="w-8 h-8 rounded-full bg-gray-100 mr-4 flex items-center justify-center font-bold">${String.fromCharCode(65+i)}</span><span>${opt}</span>`;
                btn.onclick = () => {
                    userAnswers[index] = i;
                    loadQuestion(index); // Recargar para actualizar UI
                    updateGrid();
                };
                cont.appendChild(btn);
            });
            
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').textContent = index === examQuestions.length-1 ? 'Finalizar' : 'Siguiente ‚Üí';
            updateGrid();
            if(window.MathJax) MathJax.typesetPromise();
        }

        function updateGrid() {
            document.querySelectorAll('.nav-grid-btn').forEach((btn, i) => {
                btn.className = `nav-grid-btn ${userAnswers[i]!==null ? 'answered' : 'bg-gray-100'} ${i===currentQuestionIndex ? 'current' : ''}`;
            });
            document.getElementById('answeredCount').textContent = userAnswers.filter(a => a!==null).length;
        }

        function prevQuestion() { if(currentQuestionIndex > 0) loadQuestion(currentQuestionIndex-1); }
        function nextQuestion() { 
            if(currentQuestionIndex < examQuestions.length-1) loadQuestion(currentQuestionIndex+1); 
            else finishExam();
        }

        function finishExam() {
            clearInterval(timerInterval);
            document.getElementById('examContent').classList.add('hidden');
            document.querySelector('header').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            
            let correct=0, incorrect=0;
            examQuestions.forEach((q, i) => {
                if(userAnswers[i] === q.correct) correct++;
                else if(userAnswers[i] !== null) incorrect++;
            });
            
            const score = Math.max(0, (correct*4) - incorrect);
            document.getElementById('totalScore').textContent = score;
            document.getElementById('totalCorrect').textContent = correct;
            document.getElementById('totalIncorrect').textContent = incorrect;
        }

        if(!localStorage.getItem('prepIA_userID')) window.location.href = 'login.html';
    </script>
</body>
</html>